<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Bi·ªÉu ƒë·ªì d·ªØ li·ªáu n∆∞·ªõc</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
    body { font-family: sans-serif; margin: 20px; }
    .controls { margin-bottom: 10px; display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    
    /* CSS cho button ƒëi·ªÅu khi·ªÉn */
    #controlBtn {
        transition: all 0.3s ease;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    #controlBtn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }
    
    #controlBtn.on {
        background-color: #f44336;
    }
    
    #controlBtn.off {
        background-color: #4CAF50;
    }
    
    .status-on {
        color: #f44336 !important;
    }
    
    .status-off {
        color: #4CAF50 !important;
    }
    </style>
</head>
<body>
    <h2>Bi·ªÉu ƒë·ªì nhi·ªát ƒë·ªô v√† ƒë·ªô ƒë·ª•c theo th·ªùi gian</h2>

    <div class="controls">
        <label>T·ª´: <input type="date" id="from-date"></label>
        <label>ƒê·∫øn: <input type="date" id="to-date"></label>
        <button onclick="loadHistory()">L·ªçc d·ªØ li·ªáu</button>
        <button onclick="enableRealtime()">Ch·∫ø ƒë·ªô th·ªùi gian th·ª±c</button>
        
        <!-- Button ƒëi·ªÅu khi·ªÉn MQTT -->
        <div style="margin-left: 20px; border-left: 2px solid #ccc; padding-left: 20px;">
            <label>ƒêi·ªÅu khi·ªÉn thi·∫øt b·ªã:</label>
            <button id="controlBtn" onclick="toggleDevice()" style="padding: 10px 20px; font-size: 16px; background-color: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer;">
                B·∫¨T THI·∫æT B·ªä
            </button>
            <span id="statusText" style="margin-left: 10px; font-weight: bold; color: #4CAF50;">THI·∫æT B·ªä: T·∫ÆT</span>
        </div>
    </div>

    <canvas id="myChart" width="600" height="300"></canvas>

    <script>
    const labels = []; // th·ªùi gian
    const tempData = []; // nhi·ªát ƒë·ªô
    const turbData = []; // ƒë·ªô ƒë·ª•c

    const ctx = document.getElementById('myChart').getContext('2d');
    const myChart = new Chart(ctx, {
        type: 'line',
        data: {
        labels: labels,
        datasets: [
            {
                label: 'Nhi·ªát ƒë·ªô (¬∞C)',
                data: tempData,
                borderWidth: 2,
                borderColor: 'red',
                fill: false
            },
            {
                label: 'ƒê·ªô ƒë·ª•c (ADC)',
                data: turbData,
                borderWidth: 2,
                borderColor: 'blue',
                fill: false
            }
        ]
        },
        options: {
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Th·ªùi gian'
                    }
                },
                y: {
                beginAtZero: true
                }
            }
        }
    });

    // üì° Nh·∫≠n d·ªØ li·ªáu th·ªùi gian th·ª±c qua WebSocket
    const socket = new WebSocket('ws://localhost:5000');
    let isRealtimeMode = true; // Bi·∫øn ƒë·ªÉ ki·ªÉm so√°t ch·∫ø ƒë·ªô realtime

    socket.onmessage = (event) => {
    if (!isRealtimeMode) return; // B·ªè qua n·∫øu kh√¥ng ·ªü ch·∫ø ƒë·ªô realtime

    const json = JSON.parse(event.data);
    console.log('Realtime:', json);

    // Ch·ªâ hi·ªÉn th·ªã ng√†y, b·ªè gi·ªù
    const dateOnly = json.timestamp.split(' ')[0] || json.timestamp.split('T')[0];
    labels.push(dateOnly);
    tempData.push(json.temperature);
    turbData.push(json.turbidity);

    // Ch·ªâ gi·ªØ l·∫°i 10 ƒëi·ªÉm g·∫ßn nh·∫•t
    if (labels.length > 10) {
        labels.shift();
        tempData.shift();
        turbData.shift();
    }

    myChart.update();
    };

    // üì• T·∫£i d·ªØ li·ªáu c≈© t·ª´ Firebase th√¥ng qua server
    async function loadHistory() {
        const from = document.getElementById('from-date').value;
        const to = document.getElementById('to-date').value;
        if (!from || !to) {
        alert('Vui l√≤ng ch·ªçn c·∫£ ng√†y b·∫Øt ƒë·∫ßu v√† k·∫øt th√∫c!');
        return;
        }

        // T·∫Øt ch·∫ø ƒë·ªô realtime khi l·ªçc d·ªØ li·ªáu
        isRealtimeMode = false;

        try {
            const response = await fetch(`http://localhost:5000/data_sensor?from=${from}&to=${to}`);
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            console.log('D·ªØ li·ªáu l·ªãch s·ª≠:', data);

            // Xo√° d·ªØ li·ªáu c≈© tr√™n bi·ªÉu ƒë·ªì
            labels.length = 0;
            tempData.length = 0;
            turbData.length = 0;

            data.forEach(d => {
            // Ch·ªâ hi·ªÉn th·ªã ng√†y, b·ªè gi·ªù
            const dateOnly = d.timestamp.split(' ')[0] || d.timestamp.split('T')[0];
            labels.push(dateOnly);
            tempData.push(d.temperature);
            turbData.push(d.turbidity);
            });
            myChart.update();
        } catch (error) {
            console.error('L·ªói khi t·∫£i d·ªØ li·ªáu:', error);
            alert('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu. Vui l√≤ng ki·ªÉm tra server!');
            // B·∫≠t l·∫°i realtime n·∫øu c√≥ l·ªói
            isRealtimeMode = true;
        }
    }

    function enableRealtime() {
        isRealtimeMode = true;
        
        labels.length = 0;
        tempData.length = 0;
        turbData.length = 0;

        // T·ª± ƒë·ªông c·∫≠p nh·∫≠t ng√†y h√¥m qua v√† h√¥m nay
        const today = new Date();
        const yesterday = new Date(today.getTime() - 24 * 60 * 60 * 1000);
        
        // Chuy·ªÉn ƒë·ªïi th√†nh ƒë·ªãnh d·∫°ng YYYY-MM-DD theo m√∫i gi·ªù ƒë·ªãa ph∆∞∆°ng
        const formatDate = (date) => {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };
        
        document.getElementById('to-date').value = formatDate(today);
        document.getElementById('from-date').value = formatDate(yesterday);

        myChart.update();
        console.log('ƒê√£ b·∫≠t ch·∫ø ƒë·ªô th·ªùi gian th·ª±c');
    }

    // ÔøΩüïí T·ª± ƒë·ªông set ng√†y h√¥m nay v√† h√¥m qua
    window.onload = () => {
        const today = new Date();
        const yesterday = new Date(today.getTime() - 24 * 60 * 60 * 1000);
        
        // Chuy·ªÉn ƒë·ªïi th√†nh ƒë·ªãnh d·∫°ng YYYY-MM-DD theo m√∫i gi·ªù ƒë·ªãa ph∆∞∆°ng
        const formatDate = (date) => {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };
        
        document.getElementById('to-date').value = formatDate(today);
        document.getElementById('from-date').value = formatDate(yesterday);
    };

    // JavaScript cho button ƒëi·ªÅu khi·ªÉn MQTT
    let deviceState = false; // false = t·∫Øt, true = b·∫≠t
    
    function toggleDevice() {
        deviceState = !deviceState;
        
        // G·ª≠i t√≠n hi·ªáu ƒëi·ªÅu khi·ªÉn ƒë·∫øn server
        sendControlSignal(deviceState ? 1 : 0);
        
        // C·∫≠p nh·∫≠t giao di·ªán
        updateButtonUI();
    }
    
    function sendControlSignal(state) {
        fetch('/api/control', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                state: state,
                timestamp: Date.now(),
                source: 'web_interface'
            })
        })
        .then(response => response.json())
        .then(data => {
            console.log('Control signal sent successfully:', data);
        })
        .catch(error => {
            console.error('Error sending control signal:', error);
            alert('L·ªói khi g·ª≠i t√≠n hi·ªáu ƒëi·ªÅu khi·ªÉn!');
            // Ho√†n t√°c tr·∫°ng th√°i n·∫øu c√≥ l·ªói
            deviceState = !deviceState;
            updateButtonUI();
        });
    }
    
    function updateButtonUI() {
        const btn = document.getElementById('controlBtn');
        const status = document.getElementById('statusText');
        
        if (deviceState) {
            // Thi·∫øt b·ªã ƒëang b·∫≠t
            btn.innerHTML = 'T·∫ÆT THI·∫æT B·ªä';
            btn.className = 'on';
            btn.style.backgroundColor = '#f44336';
            status.innerHTML = 'THI·∫æT B·ªä: B·∫¨T';
            status.className = 'status-on';
        } else {
            // Thi·∫øt b·ªã ƒëang t·∫Øt
            btn.innerHTML = 'B·∫¨T THI·∫æT B·ªä';
            btn.className = 'off';
            btn.style.backgroundColor = '#4CAF50';
            status.innerHTML = 'THI·∫æT B·ªä: T·∫ÆT';
            status.className = 'status-off';
        }
    }
</script>
</body>
</html>
