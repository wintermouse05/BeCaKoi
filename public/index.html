<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Biá»ƒu Ä‘á»“ dá»¯ liá»‡u nÆ°á»›c</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
    body { font-family: sans-serif; margin: 20px; }
    .controls { margin-bottom: 10px; display: flex; gap: 10px; flex-wrap: wrap; }
    </style>
</head>
<body>
    <h2>Biá»ƒu Ä‘á»“ nhiá»‡t Ä‘á»™ vÃ  Ä‘á»™ Ä‘á»¥c theo thá»i gian</h2>

    <div class="controls">
        <label>Tá»«: <input type="date" id="from-date"></label>
        <label>Äáº¿n: <input type="date" id="to-date"></label>
        <button onclick="loadHistory()">Lá»c dá»¯ liá»‡u</button>
        <button onclick="enableRealtime()">Cháº¿ Ä‘á»™ thá»i gian thá»±c</button>
    </div>

    <canvas id="myChart" width="600" height="300"></canvas>

    <script>
    const labels = []; // thá»i gian
    const tempData = []; // nhiá»‡t Ä‘á»™
    const turbData = []; // Ä‘á»™ Ä‘á»¥c

    const ctx = document.getElementById('myChart').getContext('2d');
    const myChart = new Chart(ctx, {
        type: 'line',
        data: {
        labels: labels,
        datasets: [
            {
                label: 'Nhiá»‡t Ä‘á»™ (Â°C)',
                data: tempData,
                borderWidth: 2,
                borderColor: 'red',
                fill: false
            },
            {
                label: 'Äá»™ Ä‘á»¥c (ADC)',
                data: turbData,
                borderWidth: 2,
                borderColor: 'blue',
                fill: false
            }
        ]
        },
        options: {
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Thá»i gian'
                    }
                },
                y: {
                beginAtZero: true
                }
            }
        }
    });

    // ğŸ“¡ Nháº­n dá»¯ liá»‡u thá»i gian thá»±c qua WebSocket
    const socket = new WebSocket('ws://localhost:3000');
    let isRealtimeMode = true; // Biáº¿n Ä‘á»ƒ kiá»ƒm soÃ¡t cháº¿ Ä‘á»™ realtime

    socket.onmessage = (event) => {
    if (!isRealtimeMode) return; // Bá» qua náº¿u khÃ´ng á»Ÿ cháº¿ Ä‘á»™ realtime

    const json = JSON.parse(event.data);
    console.log('Realtime:', json);

    // Chá»‰ hiá»ƒn thá»‹ ngÃ y, bá» giá»
    const dateOnly = json.timestamp.split(' ')[0] || json.timestamp.split('T')[0];
    labels.push(dateOnly);
    tempData.push(json.temperature);
    turbData.push(json.turbidity);

    // Chá»‰ giá»¯ láº¡i 10 Ä‘iá»ƒm gáº§n nháº¥t
    if (labels.length > 10) {
        labels.shift();
        tempData.shift();
        turbData.shift();
    }

    myChart.update();
    };

    // ğŸ“¥ Táº£i dá»¯ liá»‡u cÅ© tá»« Firebase thÃ´ng qua server
    async function loadHistory() {
        const from = document.getElementById('from-date').value;
        const to = document.getElementById('to-date').value;
        if (!from || !to) {
        alert('Vui lÃ²ng chá»n cáº£ ngÃ y báº¯t Ä‘áº§u vÃ  káº¿t thÃºc!');
        return;
        }

        // Táº¯t cháº¿ Ä‘á»™ realtime khi lá»c dá»¯ liá»‡u
        isRealtimeMode = false;

        try {
            const response = await fetch(`http://localhost:3000/data_sensor?from=${from}&to=${to}`);
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            console.log('Dá»¯ liá»‡u lá»‹ch sá»­:', data);

            // XoÃ¡ dá»¯ liá»‡u cÅ© trÃªn biá»ƒu Ä‘á»“
            labels.length = 0;
            tempData.length = 0;
            turbData.length = 0;

            data.forEach(d => {
            // Chá»‰ hiá»ƒn thá»‹ ngÃ y, bá» giá»
            const dateOnly = d.timestamp.split(' ')[0] || d.timestamp.split('T')[0];
            labels.push(dateOnly);
            tempData.push(d.temperature);
            turbData.push(d.turbidity);
            });
            myChart.update();
        } catch (error) {
            console.error('Lá»—i khi táº£i dá»¯ liá»‡u:', error);
            alert('KhÃ´ng thá»ƒ táº£i dá»¯ liá»‡u. Vui lÃ²ng kiá»ƒm tra server!');
            // Báº­t láº¡i realtime náº¿u cÃ³ lá»—i
            isRealtimeMode = true;
        }
    }

    function enableRealtime() {
        isRealtimeMode = true;
        
        labels.length = 0;
        tempData.length = 0;
        turbData.length = 0;

        // Tá»± Ä‘á»™ng cáº­p nháº­t ngÃ y hÃ´m qua vÃ  hÃ´m nay
        const today = new Date();
        const yesterday = new Date(today.getTime() - 24 * 60 * 60 * 1000);
        
        // Chuyá»ƒn Ä‘á»•i thÃ nh Ä‘á»‹nh dáº¡ng YYYY-MM-DD theo mÃºi giá» Ä‘á»‹a phÆ°Æ¡ng
        const formatDate = (date) => {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };
        
        document.getElementById('to-date').value = formatDate(today);
        document.getElementById('from-date').value = formatDate(yesterday);

        myChart.update();
        console.log('ÄÃ£ báº­t cháº¿ Ä‘á»™ thá»i gian thá»±c');
    }

    // ï¿½ğŸ•’ Tá»± Ä‘á»™ng set ngÃ y hÃ´m nay vÃ  hÃ´m qua
    window.onload = () => {
        const today = new Date();
        const yesterday = new Date(today.getTime() - 24 * 60 * 60 * 1000);
        
        // Chuyá»ƒn Ä‘á»•i thÃ nh Ä‘á»‹nh dáº¡ng YYYY-MM-DD theo mÃºi giá» Ä‘á»‹a phÆ°Æ¡ng
        const formatDate = (date) => {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };
        
        document.getElementById('to-date').value = formatDate(today);
        document.getElementById('from-date').value = formatDate(yesterday);
    };
</script>
</body>
</html>
